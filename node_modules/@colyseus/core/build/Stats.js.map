{
  "version": 3,
  "sources": ["../src/Stats.ts"],
  "sourcesContent": ["import { presence, processId } from \"./MatchMaker\";\n\nexport type Stats = {\n  roomCount: number;\n  ccu: number;\n}\n\nexport let local: Stats = {\n  roomCount: 0,\n  ccu: 0,\n};\n\nexport async function fetchAll() {\n  // TODO: cache this value to avoid querying too often\n  const allStats: Array<Stats & { processId: string }> = [];\n  const allProcesses = await presence.hgetall(getRoomCountKey());\n  for (let remoteProcessId in allProcesses) {\n    if (remoteProcessId === processId) {\n      allStats.push({ processId, roomCount: local.roomCount, ccu: local.ccu, });\n\n    } else {\n      const [roomCount, ccu] = allProcesses[remoteProcessId].split(',').map(Number);\n      allStats.push({ processId: remoteProcessId, roomCount, ccu });\n    }\n  }\n  return allStats;\n}\n\nlet lastPersisted = 0;\nlet persistTimeout = undefined;\nconst persistInterval = 1000;\n\nexport function persist(forceNow: boolean = false) {\n  /**\n   * Avoid persisting too often.\n   */\n  const now = Date.now();\n\n  if (forceNow || (now - lastPersisted > persistInterval)) {\n    lastPersisted = now;\n    return presence.hset(getRoomCountKey(), processId, `${local.roomCount},${local.ccu}`);\n\n  } else {\n    clearTimeout(persistTimeout);\n    persistTimeout = setTimeout(persist, persistInterval);\n  }\n}\n\nexport function reset(_persist: boolean = true) {\n  local.roomCount = 0;\n  local.ccu = 0;\n\n  if (_persist) {\n    lastPersisted = 0;\n    clearTimeout(persistTimeout);\n    persist();\n  }\n}\n\nexport function excludeProcess(_processId: string) {\n  return presence.hdel(getRoomCountKey(), _processId);\n}\n\nexport async function getGlobalCCU() {\n  const allStats = await fetchAll();\n  return allStats.reduce((prev, next) => prev + next.ccu, 0);\n}\n\nfunction getRoomCountKey() {\n  return 'roomcount';\n}"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wBAAoC;AAO7B,IAAI,QAAe;AAAA,EACxB,WAAW;AAAA,EACX,KAAK;AACP;AAEA,eAAsB,WAAW;AAE/B,QAAM,WAAiD,CAAC;AACxD,QAAM,eAAe,MAAM,2BAAS,QAAQ,gBAAgB,CAAC;AAC7D,WAAS,mBAAmB,cAAc;AACxC,QAAI,oBAAoB,6BAAW;AACjC,eAAS,KAAK,EAAE,wCAAW,WAAW,MAAM,WAAW,KAAK,MAAM,IAAK,CAAC;AAAA,IAE1E,OAAO;AACL,YAAM,CAAC,WAAW,GAAG,IAAI,aAAa,iBAAiB,MAAM,GAAG,EAAE,IAAI,MAAM;AAC5E,eAAS,KAAK,EAAE,WAAW,iBAAiB,WAAW,IAAI,CAAC;AAAA,IAC9D;AAAA,EACF;AACA,SAAO;AACT;AAEA,IAAI,gBAAgB;AACpB,IAAI,iBAAiB;AACrB,MAAM,kBAAkB;AAEjB,SAAS,QAAQ,WAAoB,OAAO;AAIjD,QAAM,MAAM,KAAK,IAAI;AAErB,MAAI,YAAa,MAAM,gBAAgB,iBAAkB;AACvD,oBAAgB;AAChB,WAAO,2BAAS,KAAK,gBAAgB,GAAG,6BAAW,GAAG,MAAM,aAAa,MAAM,KAAK;AAAA,EAEtF,OAAO;AACL,iBAAa,cAAc;AAC3B,qBAAiB,WAAW,SAAS,eAAe;AAAA,EACtD;AACF;AAEO,SAAS,MAAM,WAAoB,MAAM;AAC9C,QAAM,YAAY;AAClB,QAAM,MAAM;AAEZ,MAAI,UAAU;AACZ,oBAAgB;AAChB,iBAAa,cAAc;AAC3B,YAAQ;AAAA,EACV;AACF;AAEO,SAAS,eAAe,YAAoB;AACjD,SAAO,2BAAS,KAAK,gBAAgB,GAAG,UAAU;AACpD;AAEA,eAAsB,eAAe;AACnC,QAAM,WAAW,MAAM,SAAS;AAChC,SAAO,SAAS,OAAO,CAAC,MAAM,SAAS,OAAO,KAAK,KAAK,CAAC;AAC3D;AAEA,SAAS,kBAAkB;AACzB,SAAO;AACT;",
  "names": []
}
