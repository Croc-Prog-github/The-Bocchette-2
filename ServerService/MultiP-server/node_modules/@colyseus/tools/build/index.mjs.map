{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["import \"./loadenv\";\nimport os from \"os\";\nimport fs from \"fs\";\nimport net from \"net\";\nimport http from \"http\";\nimport cors from \"cors\";\nimport express from \"express\";\nimport osUtils from \"node-os-utils\";\nimport { logger, Server, ServerOptions, Transport, matchMaker } from '@colyseus/core';\nimport { WebSocketTransport } from '@colyseus/ws-transport';\n\n// try to import uWebSockets-express compatibility layer.\nlet uWebSocketsExpressCompatibility: any = undefined;\ntry { uWebSocketsExpressCompatibility = require('uwebsockets-express').default; } catch (e) { }\n\nlet BunWebSockets: any = undefined;\ntry { BunWebSockets = require('@colyseus/bun-websockets'); } catch (e) { }\n\nexport interface ConfigOptions {\n    options?: ServerOptions,\n    displayLogs?: boolean,\n    getId?: () => string,\n    initializeTransport?: (options: any) => Transport,\n    initializeExpress?: (app: express.Express) => void,\n    initializeGameServer?: (app: Server) => void,\n    beforeListen?: () => void,\n}\n\nconst ALLOWED_KEYS: { [key in keyof ConfigOptions]: string } = {\n  'displayLogs': \"boolean\",\n  'options': \"object\",\n  'getId': \"function\",\n  'initializeTransport': \"function\",\n  'initializeExpress': \"function\",\n  'initializeGameServer': \"function\",\n  'beforeListen': \"function\"\n};\n\nexport default function (options: ConfigOptions) {\n  for (const option in options) {\n    if (!ALLOWED_KEYS[option]) {\n      throw new Error(`\u274C Invalid option '${option}'. Allowed options are: ${Object.keys(ALLOWED_KEYS).join(\", \")}`);\n    }\n    if(options[option] !== undefined && typeof(options[option]) !== ALLOWED_KEYS[option]) {\n      throw new Error(`\u274C Invalid type for ${option}: please provide a ${ALLOWED_KEYS[option]} value.`);\n    }\n  }\n\n  return options;\n}\n\n/**\n * Listen on your development environment\n * @param options Application options\n * @param port Port number to bind Colyseus + Express\n */\nexport async function listen(\n    options: ConfigOptions,\n    port: number = Number(process.env.PORT || 2567),\n) {\n    const serverOptions = options.options || {};\n    options.displayLogs = options.displayLogs ?? true;\n\n    // Force 2567 port on Colyseus Cloud\n    if (process.env.COLYSEUS_CLOUD !== undefined) {\n        port = 2567;\n    }\n\n    //\n    // Handling multiple processes\n    // Use NODE_APP_INSTANCE to play nicely with pm2\n    //\n    const processNumber = Number(process.env.NODE_APP_INSTANCE || \"0\");\n    port += processNumber;\n\n    let portOrSocket: any = port;\n\n    // automatically configure for production under Colyseus Cloud\n    if (process.env.COLYSEUS_CLOUD !== undefined) {\n        portOrSocket = `/run/colyseus/${port}.sock`;\n\n        // check if .sock file is active\n        // (fixes \"ADDRINUSE\" issue when restarting the server)\n        await checkInactiveSocketFile(portOrSocket);\n\n        // special configuration is required when using multiple processes\n        const useRedisConfig = (os.cpus().length > 1) || (process.env.REDIS_URI !== undefined);\n\n        if (!serverOptions.driver && useRedisConfig) {\n            let RedisDriver: any = undefined;\n            try {\n                RedisDriver = require('@colyseus/redis-driver').RedisDriver;\n                serverOptions.driver = new RedisDriver(process.env.REDIS_URI);\n            } catch (e) {\n                logger.warn(\"\");\n                logger.warn(\"\u274C could not initialize RedisDriver.\");\n                logger.warn(\"\uD83D\uDC49 npm install --save @colyseus/redis-driver\");\n                logger.warn(\"\");\n            }\n        }\n\n        if (!serverOptions.presence && useRedisConfig) {\n            let RedisPresence: any = undefined;\n            try {\n                RedisPresence = require('@colyseus/redis-presence').RedisPresence;\n                serverOptions.presence = new RedisPresence(process.env.REDIS_URI);\n            } catch (e) {\n                logger.warn(\"\");\n                logger.warn(\"\u274C could not initialize RedisPresence.\");\n                logger.warn(\"\uD83D\uDC49 npm install --save @colyseus/redis-presence\");\n                logger.warn(\"\");\n            }\n        }\n\n        if (useRedisConfig) {\n            // force \"publicAddress\" when more than 1 process is available\n            serverOptions.publicAddress = process.env.SUBDOMAIN + \".\" + process.env.SERVER_NAME;\n\n            // nginx is responsible for forwarding /{port}/ to this process\n            serverOptions.publicAddress += \"/\" + port;\n        }\n    }\n\n    const transport = await getTransport(options);\n    const gameServer = new Server({\n        ...serverOptions,\n        transport,\n    });\n    await options.initializeGameServer?.(gameServer);\n    await matchMaker.onReady;\n    await options.beforeListen?.();\n\n    // listening on port or socket\n    await gameServer.listen(portOrSocket);\n\n    // notify process manager (production)\n    if (typeof(process.send) === \"function\") {\n        process.send('ready');\n    }\n\n    if (options.displayLogs) {\n        logger.info(`\u2694\uFE0F  Listening on http://localhost:${port}`);\n    }\n    return gameServer;\n}\n\n\nexport async function getTransport(options: ConfigOptions) {\n    let transport: Transport;\n\n    if (!options.initializeTransport) {\n        if (BunWebSockets !== undefined) {\n          // @colyseus/bun-websockets\n          options.initializeTransport = (options: any) => new BunWebSockets.BunWebSockets(options);\n\n        } else {\n          // use WebSocketTransport by default\n          options.initializeTransport = (options: any) => new WebSocketTransport(options);\n        }\n    }\n\n    let app: express.Express | undefined = express();\n    let server = http.createServer(app);\n\n    transport = await options.initializeTransport({ server });\n\n    //\n    // TODO: refactor me!\n    // BunWebSockets: There's no need to instantiate \"app\" and \"server\" above\n    //\n    if (transport['expressApp']) {\n      app = transport['expressApp'];\n    }\n\n    if (options.initializeExpress) {\n        // uWebSockets.js + Express compatibility layer.\n        // @ts-ignore\n        if (transport['app']) {\n            if (typeof (uWebSocketsExpressCompatibility) === \"function\") {\n                if (options.displayLogs){\n                  logger.info(\"\u2705 uWebSockets.js + Express compatibility enabled\");\n                }\n\n                // @ts-ignore\n                server = undefined;\n                // @ts-ignore\n                app = uWebSocketsExpressCompatibility(transport['app']);\n\n            } else {\n                if (options.displayLogs) {\n                    logger.warn(\"\");\n                    logger.warn(\"\u274C uWebSockets.js + Express compatibility mode couldn't be loaded, run the following command to fix:\");\n                    logger.warn(\"\uD83D\uDC49 npm install --save uwebsockets-express\");\n                    logger.warn(\"\");\n                }\n                app = undefined;\n            }\n        }\n    }\n\n    if (app) {\n      // Enable CORS\n      app.use(cors({ origin: true, credentials: true, }));\n\n      // Enable JSON parsing.\n      app.use(express.json());\n\n      if (options.initializeExpress) {\n          await options.initializeExpress(app);\n      }\n\n      // health check for load balancers\n      app.get(\"/__healthcheck\", (req, res) => {\n        res.status(200).end();\n      });\n\n      app.get(\"/__cloudstats\", async (req, res) => {\n          if (\n              process.env.CLOUD_SECRET &&\n              req.headers.authorization !== process.env.CLOUD_SECRET\n          ) {\n              res.status(401).end();\n              return;\n          }\n\n          // count rooms per process\n          const rooms = (await matchMaker.stats.fetchAll()).reduce((prev, curr) => {\n            return prev + curr.roomCount;\n          }, 0);\n\n          const ccu = await matchMaker.stats.getGlobalCCU();\n          const mem = await osUtils.mem.used();\n          const cpu = (await osUtils.cpu.usage()) / 100;\n\n          res.json({\n              version: 1,\n              mem: (mem.usedMemMb / mem.totalMemMb),\n              cpu,\n              ccu,\n              rooms,\n          });\n      });\n\n      if (options.displayLogs) {\n          logger.info(\"\u2705 Express initialized\");\n      }\n    }\n\n    return transport;\n}\n\n/**\n * Check if a socket file is active and remove it if it's not.\n */\nfunction checkInactiveSocketFile(sockFilePath: string) {\n  return new Promise((resolve, reject) => {\n    const client = net.createConnection({ path: sockFilePath })\n      .on('connect', () => {\n        // socket file is active, close the connection\n        client.end();\n        throw new Error(`EADDRINUSE: Already listening on '${sockFilePath}'`);\n      })\n      .on('error', () => {\n        // socket file is inactive, remove it\n        fs.unlink(sockFilePath, () => resolve(true));\n      });\n  });\n}"],
  "mappings": "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",
  "names": ["options"]
}
