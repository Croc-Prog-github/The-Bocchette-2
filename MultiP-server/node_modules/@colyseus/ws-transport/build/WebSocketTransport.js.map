{
  "version": 3,
  "sources": ["../src/WebSocketTransport.ts"],
  "sourcesContent": ["import http from 'http';\nimport { URL } from 'url';\nimport WebSocket, { ServerOptions } from 'ws';\n\nimport { matchMaker, Protocol, Transport, debugAndPrintError, debugConnection } from '@colyseus/core';\nimport { WebSocketClient } from './WebSocketClient';\n\nfunction noop() {/* tslint:disable:no-empty */ }\nfunction heartbeat() { this.pingCount = 0; }\n\ntype RawWebSocketClient = WebSocket & { pingCount: number };\n\nexport interface TransportOptions extends ServerOptions {\n  pingInterval?: number;\n  pingMaxRetries?: number;\n}\n\nexport class WebSocketTransport extends Transport {\n  protected wss: WebSocket.Server;\n\n  protected pingInterval: NodeJS.Timer;\n  protected pingIntervalMS: number;\n  protected pingMaxRetries: number;\n\n  constructor(options: TransportOptions = {}) {\n    super();\n\n    // disable per-message deflate by default\n    if (options.perMessageDeflate === undefined) {\n      options.perMessageDeflate = false;\n    }\n\n    this.pingIntervalMS = (options.pingInterval !== undefined)\n      ? options.pingInterval\n      : 3000;\n\n    this.pingMaxRetries = (options.pingMaxRetries !== undefined)\n      ? options.pingMaxRetries\n      : 2;\n\n    // create server by default\n    if (!options.server && !options.noServer) {\n      options.server = http.createServer();\n    }\n\n    this.wss = new WebSocket.Server(options);\n    this.wss.on('connection', this.onConnection);\n\n    // this is required to allow the ECONNRESET error to trigger on the `server` instance.\n    this.wss.on('error', (err) => debugAndPrintError(err));\n\n    this.server = options.server;\n\n    if (this.pingIntervalMS > 0 && this.pingMaxRetries > 0) {\n      this.server.on('listening', () =>\n        this.autoTerminateUnresponsiveClients(this.pingIntervalMS, this.pingMaxRetries));\n\n      this.server.on('close', () =>\n        clearInterval(this.pingInterval));\n    }\n  }\n\n  public listen(port: number, hostname?: string, backlog?: number, listeningListener?: () => void) {\n    this.server.listen(port, hostname, backlog, listeningListener);\n    return this;\n  }\n\n  public shutdown() {\n    this.wss.close();\n    this.server.close();\n  }\n\n  public simulateLatency(milliseconds: number) {\n    const previousSend = WebSocket.prototype.send;\n    WebSocket.prototype.send = function(...args: any[]) {\n      setTimeout(() => previousSend.apply(this, args), milliseconds);\n    };\n  }\n\n  protected autoTerminateUnresponsiveClients(pingInterval: number, pingMaxRetries: number) {\n    // interval to detect broken connections\n    this.pingInterval = setInterval(() => {\n      this.wss.clients.forEach((client: WebSocket) => {\n        //\n        // if client hasn't responded after the interval, terminate its connection.\n        //\n        if ((client as RawWebSocketClient).pingCount >= pingMaxRetries) {\n          // debugConnection(`terminating unresponsive client ${client.sessionId}`);\n          debugConnection(`terminating unresponsive client`);\n          return client.terminate();\n        }\n\n        (client as RawWebSocketClient).pingCount++;\n        client.ping(noop);\n      });\n    }, pingInterval);\n  }\n\n  protected async onConnection(rawClient: RawWebSocketClient, req?: http.IncomingMessage & any) {\n    // prevent server crashes if a single client had unexpected error\n    rawClient.on('error', (err) => debugAndPrintError(err.message + '\\n' + err.stack));\n    rawClient.on('pong', heartbeat);\n\n    // compatibility with ws / uws\n    const upgradeReq = req || (rawClient as any).upgradeReq;\n    const parsedURL = new URL(`ws://server/${upgradeReq.url}`);\n\n    const sessionId = parsedURL.searchParams.get(\"sessionId\");\n    const processAndRoomId = parsedURL.pathname.match(/\\/[a-zA-Z0-9_\\-]+\\/([a-zA-Z0-9_\\-]+)$/);\n    const roomId = processAndRoomId && processAndRoomId[1];\n\n    const room = matchMaker.getRoomById(roomId);\n\n    // set client id\n    rawClient.pingCount = 0;\n\n    const client = new WebSocketClient(sessionId, rawClient);\n\n    //\n    // TODO: DRY code below with all transports\n    //\n\n    try {\n      if (!room || !room.hasReservedSeat(sessionId, parsedURL.searchParams.get(\"reconnectionToken\"))) {\n        throw new Error('seat reservation expired.');\n      }\n\n      await room._onJoin(client, upgradeReq);\n\n    } catch (e) {\n      debugAndPrintError(e);\n\n      // send error code to client then terminate\n      client.error(e.code, e.message, () =>\n        rawClient.close(Protocol.WS_CLOSE_WITH_ERROR));\n    }\n  }\n\n}\n"],
  "mappings": "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",
  "names": ["http", "WebSocket"]
}
